<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDC Dashboard - Orders</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat { background: #f0f0f0; padding: 20px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .status-completed { color: green; }
        .status-pending { color: orange; }
        .status-declined { color: red; }
        .status-in_progress { color: blue; }
        .status-cancelled { color: gray; }
        .transaction-stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .transaction-stat { background: #fff3cd; padding: 15px; border-radius: 5px; min-width: 200px; }
        .transaction-stat h4 { margin: 0 0 10px 0; color: #856404; }
        .transaction-stat p { margin: 5px 0; }
        .transaction-type { padding: 2px 6px; border-radius: 3px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; }
        .transaction-type-sale { background: #d4edda; color: #155724; }
        .transaction-type-refund { background: #f8d7da; color: #721c24; }
        .transaction-type-repair { background: #fff3cd; color: #856404; }
        .transaction-type-service { background: #d1ecf1; color: #0c5460; }
        .transaction-type-trade_in { background: #e2e3e5; color: #383d41; }
        .category-stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .category-stat { background: #e8f4fd; padding: 15px; border-radius: 5px; min-width: 200px; }
        .category-stat h4 { margin: 0 0 10px 0; color: #2c5aa0; }
        .category-stat p { margin: 5px 0; }
        .filters { display: flex; gap: 20px; margin-bottom: 20px; align-items: end; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; min-width: 150px; }
        .filter-group label { margin-bottom: 5px; font-weight: bold; }
        .filter-group select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .clear-filters-btn { padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .clear-filters-btn:hover { background: #c82333; }
        .usa-map { margin: 20px 0; text-align: center; }
        .usa-map svg { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px; }
        .state { fill: #e9ecef; stroke: #fff; stroke-width: 1; transition: fill 0.3s ease; }
        .state:hover { fill: #007bff; cursor: pointer; }
        .state.selected { fill: #28a745; }
        .state-high { fill: #28a745; }
        .state-medium { fill: #ffc107; }
        .state-low { fill: #dc3545; }
        .map-legend { display: flex; justify-content: center; gap: 20px; margin: 10px 0; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 20px; height: 20px; border-radius: 3px; }
        .state-details { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; display: none; }
        .state-details h3 { margin-top: 0; color: #495057; }
    </style>
</head>
<body>
    <h1>Real-Time Order Dashboard</h1>

    <div class="stats">
        <div class="stat">
            <h3>Total Transactions</h3>
            <p id="totalTransactions"><%= totalTransactions %></p>
        </div>
        <div class="stat">
            <h3>Total Revenue</h3>
            <p id="totalRevenue">$<%= totalRevenue.toFixed(2) %></p>
        </div>
        <div class="stat">
            <h3>Last Updated</h3>
            <p id="lastUpdated">Just now</p>
        </div>
        <div class="stat">
            <h3>Data Latency</h3>
            <p id="latency">~5s</p>
        </div>
        <div class="stat">
            <h3>Status</h3>
            <p id="status">ðŸ”„ Active</p>
        </div>
    </div>

    <h2>Transaction Type Breakdown</h2>
    <div class="transaction-stats">
        <% Object.keys(transactionTypeStats).forEach(type => { %>
        <div class="transaction-stat">
            <h4><%= type.charAt(0).toUpperCase() + type.slice(1) %></h4>
            <p><strong>Transactions:</strong> <%= transactionTypeStats[type].count %></p>
            <p><strong>Revenue:</strong> $<%= transactionTypeStats[type].revenue.toFixed(2) %></p>
        </div>
        <% }) %>
    </div>

    <h2>Category Breakdown (Product Transactions)</h2>
    <div class="category-stats">
        <% Object.keys(categoryStats).forEach(category => { %>
        <div class="category-stat">
            <h4><%= category %></h4>
            <p><strong>Transactions:</strong> <%= categoryStats[category].count %></p>
            <% if (category !== 'Repairs, Genius Bar and Support') { %>
            <p><strong>Revenue:</strong> $<%= categoryStats[category].revenue.toFixed(2) %></p>
            <% } %>
        </div>
        <% }) %>
    </div>

    <h2>Regional Sales Dashboard</h2>
    <div class="filters">
        <div class="filter-group">
            <label for="regionFilter">Filter by Region:</label>
            <select id="regionFilter">
                <option value="">All Regions</option>
                <option value="West">West</option>
                <option value="Northeast">Northeast</option>
                <option value="South">South</option>
                <option value="Midwest">Midwest</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="stateFilter">Filter by State:</label>
            <select id="stateFilter">
                <option value="">All States</option>
                <option value="CA">California</option>
                <option value="NY">New York</option>
                <option value="TX">Texas</option>
                <option value="FL">Florida</option>
                <option value="WA">Washington</option>
                <option value="IL">Illinois</option>
            </select>
        </div>
        <button class="clear-filters-btn" onclick="clearFilters()">Clear Filters</button>
    </div>

    <div class="usa-map">
        <h3>Sales Details</h3>
        <p>Click on any state to view detailed transaction information</p>
        <div id="map-container"></div>

        <div class="map-legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #28a745;"></div>
                <span>High Performance</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffc107;"></div>
                <span>Medium Performance</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #dc3545;"></div>
                <span>Low Performance</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e9ecef;"></div>
                <span>No Data</span>
            </div>
        </div>
    </div>

    <div id="stateDetails" class="state-details">
        <h3 id="stateName">State Details</h3>
        <div id="stateStats">
            <p><strong>Total Transactions:</strong> <span id="stateTransactions">-</span></p>
            <p><strong>Total Revenue:</strong> $<span id="stateRevenue">-</span></p>
            <p><strong>Number of Stores:</strong> <span id="stateStores">-</span></p>
            <p><strong>Average Transaction:</strong> $<span id="stateAvgTransaction">-</span></p>
        </div>
    </div>

    <div id="regionalSummary" class="stats">
        <!-- Regional summary will be populated by JavaScript -->
    </div>

    <h2>Recent Transactions</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Customer</th>
                <th>Store</th>
                <th>City</th>
                <th>State</th>
                <th>County</th>
                <th>ZIP</th>
                <th>Region</th>
                <th>Product</th>
                <th>Category</th>
                <th>Subcategory</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Total</th>
                <th>Date</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="transactionsTable">
            <% transactions.forEach(transaction => { %>
            <tr>
                <td><%= transaction.id %></td>
                <td><span class="transaction-type transaction-type-<%= transaction.transaction_type %>"><%= transaction.transaction_type %></span></td>
                <td><%= transaction.customer_name %></td>
                <td><%= transaction.store_name %></td>
                <td><%= transaction.store_city || 'N/A' %></td>
                <td><%= transaction.store_state || 'N/A' %></td>
                <td><%= transaction.store_county || 'N/A' %></td>
                <td><%= transaction.store_zip_code || 'N/A' %></td>
                <td><%= transaction.store_region || 'N/A' %></td>
                <td><%= transaction.product_name || 'N/A' %></td>
                <td><%= transaction.category_name || 'N/A' %></td>
                <td><%= transaction.subcategory_name || 'N/A' %></td>
                <td><%= transaction.quantity %></td>
                <td>$<%= transaction.unit_price || 'N/A' %></td>
                <td>$<%= transaction.total_amount %></td>
                <td><%= new Date(transaction.transaction_date).toLocaleString() %></td>
                <td class="status-<%= transaction.status %>"><%= transaction.status %></td>
            </tr>
            <% }) %>
        </tbody>
    </table>

    <script>
        let lastUpdateTime = Date.now();
        let updateCount = 0;
        let existingOrderIds = new Set();

        function updateDashboard() {
            updateCount++;
            const startTime = Date.now();

            // Update status to show we're fetching
            document.getElementById('status').textContent = 'ðŸ”„ Updating...';
            console.log(`[Dashboard] Update #${updateCount} started at ${new Date().toLocaleTimeString()}`);

            fetch('/data')
                .then(response => {
                    console.log(`[Dashboard] Fetch response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    const fetchTime = Date.now();
                    const latency = fetchTime - startTime;
                    console.log(`[Dashboard] Data received: ${data.totalTransactions} transactions, latency: ${latency}ms`);

                    // Store all transactions for filtering
                    allTransactions = data.transactions;
                    if (filteredTransactions.length === 0) {
                        filteredTransactions = [...allTransactions];
                    }

                    // Update regional summary
                    updateRegionalSummary(filteredTransactions);

                    // Update all the display elements
                    document.getElementById('totalTransactions').textContent = data.totalTransactions;
                    document.getElementById('totalRevenue').textContent = '$' + data.totalRevenue.toFixed(2);

                    // Update last updated time
                    const now = new Date();
                    document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();

                    // Update latency
                    document.getElementById('latency').textContent = `${latency}ms`;

                    // Update status
                    document.getElementById('status').textContent = 'âœ… Updated';

                    // Add new transactions to the top of the table (incremental updates)
                    const tbody = document.getElementById('transactionsTable');
                    let newTransactionsAdded = 0;

                    // Process transactions in reverse order (newest first) to add them at the top
                    const newTransactions = data.transactions.filter(transaction => !existingOrderIds.has(transaction.id));

                    newTransactions.forEach(transaction => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${transaction.id}</td>
                            <td><span class="transaction-type transaction-type-${transaction.transaction_type}">${transaction.transaction_type}</span></td>
                            <td>${transaction.customer_name}</td>
                            <td>${transaction.store_name}</td>
                            <td>${transaction.store_city || 'N/A'}</td>
                            <td>${transaction.store_state || 'N/A'}</td>
                            <td>${transaction.store_county || 'N/A'}</td>
                            <td>${transaction.store_zip_code || 'N/A'}</td>
                            <td>${transaction.store_region || 'N/A'}</td>
                            <td>${transaction.product_name || 'N/A'}</td>
                            <td>${transaction.category_name || 'N/A'}</td>
                            <td>${transaction.subcategory_name || 'N/A'}</td>
                            <td>${transaction.quantity}</td>
                            <td>$${transaction.unit_price || 'N/A'}</td>
                            <td>$${transaction.total_amount}</td>
                            <td>${new Date(transaction.transaction_date).toLocaleString()}</td>
                            <td class="status-${transaction.status}">${transaction.status}</td>
                        `;

                        // Add highlight effect for new transactions
                        row.style.backgroundColor = '#e8f5e8';
                        setTimeout(() => {
                            row.style.transition = 'background-color 2s';
                            row.style.backgroundColor = '';
                        }, 100);

                        // Insert at the top of the table
                        tbody.insertBefore(row, tbody.firstChild);
                        existingOrderIds.add(transaction.id);
                        newTransactionsAdded++;
                    });

                    if (newTransactionsAdded > 0) {
                        console.log(`[Dashboard] Added ${newTransactionsAdded} new transactions to the top of the table`);
                    }

                    // Reset status after 2 seconds
                    setTimeout(() => {
                        document.getElementById('status').textContent = 'ðŸ”„ Active';
                    }, 2000);

                    lastUpdateTime = fetchTime;
                    console.log(`[Dashboard] Update #${updateCount} completed successfully`);
                })
                .catch(error => {
                    console.error('[Dashboard] Error updating dashboard:', error);
                    document.getElementById('latency').textContent = 'Error';
                    document.getElementById('status').textContent = 'âŒ Error';
                });
        }

        console.log('[Dashboard] JavaScript loaded, setting up polling...');

        // Update every 5 seconds (temporarily faster for testing)
        setInterval(() => {
            console.log('[Dashboard] 5-second interval triggered');
            updateDashboard();
        }, 5000);

        // Initialize existing transaction IDs from server-rendered content
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize existing transaction IDs
            const existingRows = document.querySelectorAll('#transactionsTable tr');
            existingRows.forEach(row => {
                const idCell = row.querySelector('td:first-child');
                if (idCell && idCell.textContent) {
                    const transactionId = parseInt(idCell.textContent);
                    if (!isNaN(transactionId)) {
                        existingOrderIds.add(transactionId);
                    }
                }
            });
            console.log(`[Dashboard] Initialized with ${existingOrderIds.size} existing transactions`);
        });

        // Regional filtering and summary functionality
        let allTransactions = [];
        let filteredTransactions = [];

        function updateRegionalSummary(transactions) {
            const regionalStats = {};

            transactions.forEach(transaction => {
                const region = transaction.store_region || 'Unknown';
                if (!regionalStats[region]) {
                    regionalStats[region] = {
                        transactions: 0,
                        revenue: 0,
                        stores: new Set()
                    };
                }
                regionalStats[region].transactions++;
                regionalStats[region].revenue += parseFloat(transaction.total_amount) || 0;
                regionalStats[region].stores.add(transaction.store_name);
            });

            const summaryContainer = document.getElementById('regionalSummary');
            summaryContainer.innerHTML = '';

            Object.keys(regionalStats).forEach(region => {
                const stat = regionalStats[region];
                const statDiv = document.createElement('div');
                statDiv.className = 'stat';
                statDiv.innerHTML = `
                    <h3>${region} Region</h3>
                    <p><strong>Transactions:</strong> ${stat.transactions}</p>
                    <p><strong>Revenue:</strong> $${stat.revenue.toFixed(2)}</p>
                    <p><strong>Stores:</strong> ${stat.stores.size}</p>
                `;
                summaryContainer.appendChild(statDiv);
            });
        }

        function applyFilters() {
            const regionFilter = document.getElementById('regionFilter').value;
            const stateFilter = document.getElementById('stateFilter').value;

            filteredTransactions = allTransactions.filter(transaction => {
                const matchesRegion = !regionFilter || transaction.store_region === regionFilter;
                const matchesState = !stateFilter || transaction.store_state === stateFilter;
                return matchesRegion && matchesState;
            });

            updateTable(filteredTransactions);
            updateRegionalSummary(filteredTransactions);
        }

        function clearFilters() {
            document.getElementById('regionFilter').value = '';
            document.getElementById('stateFilter').value = '';
            filteredTransactions = [...allTransactions];
            updateTable(filteredTransactions);
            updateRegionalSummary(filteredTransactions);
        }

        function updateTable(transactions) {
            const tbody = document.getElementById('transactionsTable');
            tbody.innerHTML = '';

            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.id}</td>
                    <td><span class="transaction-type transaction-type-${transaction.transaction_type}">${transaction.transaction_type}</span></td>
                    <td>${transaction.customer_name}</td>
                    <td>${transaction.store_name}</td>
                    <td>${transaction.store_city || 'N/A'}</td>
                    <td>${transaction.store_state || 'N/A'}</td>
                    <td>${transaction.store_county || 'N/A'}</td>
                    <td>${transaction.store_zip_code || 'N/A'}</td>
                    <td>${transaction.store_region || 'N/A'}</td>
                    <td>${transaction.product_name || 'N/A'}</td>
                    <td>${transaction.category_name || 'N/A'}</td>
                    <td>${transaction.subcategory_name || 'N/A'}</td>
                    <td>${transaction.quantity}</td>
                    <td>$${transaction.unit_price || 'N/A'}</td>
                    <td>$${transaction.total_amount}</td>
                    <td>${new Date(transaction.transaction_date).toLocaleString()}</td>
                    <td class="status-${transaction.status}">${transaction.status}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Add event listeners for filters
        document.getElementById('regionFilter').addEventListener('change', applyFilters);
        document.getElementById('stateFilter').addEventListener('change', applyFilters);

        // D3.js Choropleth Map functionality
        let selectedState = null;
        let stateData = {};
        let svg, path, states;

        // Initialize the map
        function initMap() {
            const width = 960;
            const height = 600;

            // Create SVG
            svg = d3.select("#map-container")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", [0, 0, width, height])
                .attr("style", "max-width: 100%; height: auto;");

            // Create projection
            const projection = d3.geoAlbersUsa()
                .scale(1300)
                .translate([width / 2, height / 2]);

            path = d3.geoPath().projection(projection);

            // Load US states data
            d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json").then(us => {
                states = topojson.feature(us, us.objects.states).features;

                // Add state name mapping
                const stateNames = {
                    "01": "Alabama", "02": "Alaska", "04": "Arizona", "05": "Arkansas", "06": "California",
                    "08": "Colorado", "09": "Connecticut", "10": "Delaware", "11": "District of Columbia",
                    "12": "Florida", "13": "Georgia", "15": "Hawaii", "16": "Idaho", "17": "Illinois",
                    "18": "Indiana", "19": "Iowa", "20": "Kansas", "21": "Kentucky", "22": "Louisiana",
                    "23": "Maine", "24": "Maryland", "25": "Massachusetts", "26": "Michigan", "27": "Minnesota",
                    "28": "Mississippi", "29": "Missouri", "30": "Montana", "31": "Nebraska", "32": "Nevada",
                    "33": "New Hampshire", "34": "New Jersey", "35": "New Mexico", "36": "New York",
                    "37": "North Carolina", "38": "North Dakota", "39": "Ohio", "40": "Oklahoma", "41": "Oregon",
                    "42": "Pennsylvania", "44": "Rhode Island", "45": "South Carolina", "46": "South Dakota",
                    "47": "Tennessee", "48": "Texas", "49": "Utah", "50": "Vermont", "51": "Virginia",
                    "53": "Washington", "54": "West Virginia", "55": "Wisconsin", "56": "Wyoming"
                };

                // State code mapping
                const stateCodes = {
                    "Alabama": "AL", "Alaska": "AK", "Arizona": "AZ", "Arkansas": "AR", "California": "CA",
                    "Colorado": "CO", "Connecticut": "CT", "Delaware": "DE", "Florida": "FL", "Georgia": "GA",
                    "Hawaii": "HI", "Idaho": "ID", "Illinois": "IL", "Indiana": "IN", "Iowa": "IA",
                    "Kansas": "KS", "Kentucky": "KY", "Louisiana": "LA", "Maine": "ME", "Maryland": "MD",
                    "Massachusetts": "MA", "Michigan": "MI", "Minnesota": "MN", "Mississippi": "MS", "Missouri": "MO",
                    "Montana": "MT", "Nebraska": "NE", "Nevada": "NV", "New Hampshire": "NH", "New Jersey": "NJ",
                    "New Mexico": "NM", "New York": "NY", "North Carolina": "NC", "North Dakota": "ND", "Ohio": "OH",
                    "Oklahoma": "OK", "Oregon": "OR", "Pennsylvania": "PA", "Rhode Island": "RI", "South Carolina": "SC",
                    "South Dakota": "SD", "Tennessee": "TN", "Texas": "TX", "Utah": "UT", "Vermont": "VT",
                    "Virginia": "VA", "Washington": "WA", "West Virginia": "WV", "Wisconsin": "WI", "Wyoming": "WY"
                };

                // Draw states
                svg.selectAll(".state")
                    .data(states)
                    .enter()
                    .append("path")
                    .attr("class", "state")
                    .attr("d", path)
                    .attr("id", d => stateCodes[stateNames[d.id]] || d.id)
                    .attr("data-name", d => stateNames[d.id] || "Unknown")
                    .on("click", function(event, d) {
                        const stateCode = stateCodes[stateNames[d.id]];
                        const stateName = stateNames[d.id];

                        // Remove previous selection
                        svg.selectAll(".state").classed("selected", false);

                        // Select new state
                        d3.select(this).classed("selected", true);
                        selectedState = stateCode;

                        // Update filters to match selected state
                        document.getElementById('stateFilter').value = stateCode;
                        document.getElementById('regionFilter').value = '';

                        // Apply filters and show details
                        applyFilters();
                        showStateDetails(stateCode);

                        console.log(`Selected state: ${stateName} (${stateCode})`);
                    })
                    .on("mouseover", function(event, d) {
                        const stateName = stateNames[d.id];
                        d3.select(this).classed("hover", true);

                        // Show tooltip
                        const tooltip = d3.select("body")
                            .append("div")
                            .attr("class", "tooltip")
                            .style("position", "absolute")
                            .style("background", "rgba(0, 0, 0, 0.8)")
                            .style("color", "white")
                            .style("padding", "8px")
                            .style("border-radius", "4px")
                            .style("font-size", "12px")
                            .style("pointer-events", "none")
                            .style("z-index", "1000");

                        const stateCode = stateCodes[stateNames[d.id]];
                        const data = stateData[stateCode];

                        if (data) {
                            tooltip.html(`
                                <strong>${stateName}</strong><br>
                                Transactions: ${data.transactions}<br>
                                Revenue: $${data.revenue.toFixed(2)}<br>
                                Stores: ${data.stores.size}
                            `);
                        } else {
                            tooltip.html(`<strong>${stateName}</strong><br>No sales data available`);
                        }

                        tooltip.style("left", (event.pageX + 10) + "px")
                               .style("top", (event.pageY - 10) + "px");
                    })
                    .on("mouseout", function() {
                        d3.select(this).classed("hover", false);
                        d3.selectAll(".tooltip").remove();
                    });

                // Initial color update
                updateMapColors();
            }).catch(error => {
                console.error("Error loading map data:", error);
                // Fallback to simple message
                d3.select("#map-container")
                    .append("div")
                    .style("text-align", "center")
                    .style("padding", "50px")
                    .style("color", "#666")
                    .html("<p>Unable to load map data. Please check your internet connection.</p>");
            });
        }

        function updateStateData(transactions) {
            stateData = {};

            transactions.forEach(transaction => {
                const state = transaction.store_state;
                if (state) {
                    if (!stateData[state]) {
                        stateData[state] = {
                            transactions: 0,
                            revenue: 0,
                            stores: new Set(),
                            avgTransaction: 0
                        };
                    }
                    stateData[state].transactions++;
                    stateData[state].revenue += parseFloat(transaction.total_amount) || 0;
                    stateData[state].stores.add(transaction.store_name);
                }
            });

            // Calculate averages
            Object.keys(stateData).forEach(state => {
                stateData[state].avgTransaction = stateData[state].revenue / stateData[state].transactions;
            });

            updateMapColors();
        }

        function updateMapColors() {
            if (!svg) return;

            // Reset all states
            svg.selectAll(".state")
                .classed("state-high", false)
                .classed("state-medium", false)
                .classed("state-low", false)
                .classed("selected", false);

            // Color states based on performance
            const revenues = Object.values(stateData).map(data => data.revenue);
            if (revenues.length > 0) {
                const maxRevenue = Math.max(...revenues);
                const minRevenue = Math.min(...revenues);

                Object.keys(stateData).forEach(state => {
                    const revenue = stateData[state].revenue;
                    const stateElement = svg.select(`#${state}`);

                    if (!stateElement.empty()) {
                        if (revenue >= maxRevenue * 0.7) {
                            stateElement.classed("state-high", true);
                        } else if (revenue >= maxRevenue * 0.4) {
                            stateElement.classed("state-medium", true);
                        } else {
                            stateElement.classed("state-low", true);
                        }
                    }
                });
            }

            // Highlight selected state
            if (selectedState) {
                const selectedElement = svg.select(`#${selectedState}`);
                if (!selectedElement.empty()) {
                    selectedElement.classed("selected", true);
                }
            }
        }

        function showStateDetails(stateCode) {
            const detailsDiv = document.getElementById('stateDetails');
            const stateNameSpan = document.getElementById('stateName');
            const transactionsSpan = document.getElementById('stateTransactions');
            const revenueSpan = document.getElementById('stateRevenue');
            const storesSpan = document.getElementById('stateStores');
            const avgSpan = document.getElementById('stateAvgTransaction');

            if (stateData[stateCode]) {
                const data = stateData[stateCode];
                const stateElement = svg ? svg.select(`#${stateCode}`) : null;
                const stateName = stateElement && !stateElement.empty() ?
                    stateElement.attr('data-name') : stateCode;

                stateNameSpan.textContent = `${stateName} Sales Details`;
                transactionsSpan.textContent = data.transactions;
                revenueSpan.textContent = data.revenue.toFixed(2);
                storesSpan.textContent = data.stores.size;
                avgSpan.textContent = data.avgTransaction.toFixed(2);

                detailsDiv.style.display = 'block';
            } else {
                stateNameSpan.textContent = 'No Data Available';
                transactionsSpan.textContent = '-';
                revenueSpan.textContent = '-';
                storesSpan.textContent = '-';
                avgSpan.textContent = '-';

                detailsDiv.style.display = 'block';
            }
        }

        function hideStateDetails() {
            document.getElementById('stateDetails').style.display = 'none';
        }

        // Initialize map when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initMap();

            // Initialize existing transaction IDs
            const existingRows = document.querySelectorAll('#transactionsTable tr');
            existingRows.forEach(row => {
                const idCell = row.querySelector('td:first-child');
                if (idCell && idCell.textContent) {
                    const transactionId = parseInt(idCell.textContent);
                    if (!isNaN(transactionId)) {
                        existingOrderIds.add(transactionId);
                    }
                }
            });
            console.log(`[Dashboard] Initialized with ${existingOrderIds.size} existing transactions`);
        });

        // Override updateRegionalSummary to also update state data
        const originalUpdateRegionalSummary = updateRegionalSummary;
        updateRegionalSummary = function(transactions) {
            originalUpdateRegionalSummary(transactions);
            updateStateData(transactions);
        };

        // Initial update
        console.log('[Dashboard] Performing initial update...');
        updateDashboard();
    </script>
</body>
</html>
